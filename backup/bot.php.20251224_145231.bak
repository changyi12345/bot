<?php
error_reporting(0);
date_default_timezone_set("Asia/Yangon");

/* ========= CFG ========= */
$BOT="";//BOT TOken
$API="https://api.telegram.org/bot$BOT/";

define("SMILE_API","https://saigameshop.com/PixelPlay/"); // ML order endpoint
define("ML_CHECK_API","https://saigameshop.com/Autogameshop/mobileLegends/server.php");

define("G2_CHECK","https://api.g2bulk.com/v1/games/checkPlayerId");
define("G2_KEY","4894e337b8aeeaf86916dea77cc2d78a3bfacf4644de70166066e389");
define("HOK_GAME","hok");

define("PUBG_API","https://saigameshop.com/Autogameshop/api.php");
define("PUBG_KEY","c89ab76ef669d22e0c9");

define("ML_FILE",__DIR__."/prices.json");
define("UC_FILE",__DIR__."/pubg_prices.json");        // bot-side list (wrapper or array)
define("CODE_FILE",__DIR__."/pubg_code_prices.json"); // bot-side list (wrapper or array)

define("UFILE",__DIR__."/data/users.json");
define("HFILE",__DIR__."/data/history.json");

define("TOPUP","@yuri_2005");
define("PS",10);

/* ========= INIT FILES ========= */
@mkdir(__DIR__."/data",0777,true);
if(!file_exists(UFILE)) file_put_contents(UFILE,"{}",LOCK_EX);
if(!file_exists(HFILE)) file_put_contents(HFILE,"{}",LOCK_EX); // history per-user array

/* ========= INPUT ========= */
$u=json_decode(file_get_contents("php://input"),true)?:[];
$cid=$u["message"]["chat"]["id"]??($u["callback_query"]["message"]["chat"]["id"]??0);
$txt=trim($u["message"]["text"]??"");
$cb =$u["callback_query"]["data"]??"";
$cbid=$u["callback_query"]["id"]??"";
$mid =$u["callback_query"]["message"]["message_id"]??0;
$umid=$u["message"]["message_id"]??0;
if(!$cid) exit;

/* ========= CORE ========= */
function h($s){return htmlspecialchars((string)$s,ENT_QUOTES,"UTF-8");}
function jr($f){return file_exists($f)?(json_decode(file_get_contents($f),true)?:[]):[];}
function jw($f,$d){
  @mkdir(dirname($f),0777,true);
  $t=$f.".tmp";
  file_put_contents($t,json_encode($d,JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT),LOCK_EX);
  @rename($t,$f);
}
function tg($m,$d){
  global $API;
  $ch=curl_init($API.$m);
  curl_setopt_array($ch,[CURLOPT_RETURNTRANSFER=>1,CURLOPT_POST=>1,CURLOPT_POSTFIELDS=>$d,CURLOPT_TIMEOUT=>25]);
  $r=curl_exec($ch); curl_close($ch);
  return json_decode($r,true)?:["ok"=>0,"raw"=>$r];
}
function send($cid,$t,$k=null){
  $p=["chat_id"=>$cid,"text"=>$t,"parse_mode"=>"HTML","disable_web_page_preview"=>true];
  if($k) $p["reply_markup"]=json_encode($k,JSON_UNESCAPED_UNICODE);
  tg("sendMessage",$p);
}
function editm($cid,$mid,$t,$k=null){
  $p=["chat_id"=>$cid,"message_id"=>$mid,"text"=>$t,"parse_mode"=>"HTML","disable_web_page_preview"=>true];
  if($k) $p["reply_markup"]=json_encode($k,JSON_UNESCAPED_UNICODE);
  tg("editMessageText",$p);
}
function cbok($id){ if($id) tg("answerCallbackQuery",["callback_query_id"=>$id,"text"=>""]); }
function delm($cid,$mid){ if($mid) tg("deleteMessage",["chat_id"=>$cid,"message_id"=>$mid]); }

function postf($url,$data){
  $ch=curl_init($url);
  curl_setopt_array($ch,[
    CURLOPT_RETURNTRANSFER=>1,
    CURLOPT_POST=>1,
    CURLOPT_POSTFIELDS=>http_build_query($data),
    CURLOPT_TIMEOUT=>30,
    CURLOPT_CONNECTTIMEOUT=>10,
    CURLOPT_FOLLOWLOCATION=>1,
    CURLOPT_SSL_VERIFYPEER=>0,
    CURLOPT_SSL_VERIFYHOST=>0
  ]);
  $r=curl_exec($ch); $e=curl_error($ch); curl_close($ch);
  if($r===false) return ["ok"=>0,"error"=>$e?: "curl_error"];
  $j=json_decode($r,true);
  return is_array($j)?$j:["ok"=>0,"error"=>"Invalid JSON","raw"=>$r];
}
function postj($url,$payload,$hdr=[]){
  $ch=curl_init($url);
  curl_setopt_array($ch,[
    CURLOPT_RETURNTRANSFER=>1,
    CURLOPT_POST=>1,
    CURLOPT_POSTFIELDS=>json_encode($payload),
    CURLOPT_TIMEOUT=>30,
    CURLOPT_CONNECTTIMEOUT=>10,
    CURLOPT_FOLLOWLOCATION=>1,
    CURLOPT_HTTPHEADER=>array_merge(["Content-Type: application/json"],$hdr),
    CURLOPT_SSL_VERIFYPEER=>0,
    CURLOPT_SSL_VERIFYHOST=>0
  ]);
  $r=curl_exec($ch); $e=curl_error($ch); curl_close($ch);
  if($r===false) return ["ok"=>0,"error"=>$e?: "curl_error"];
  $j=json_decode($r,true);
  return is_array($j)?$j:["ok"=>0,"error"=>"Invalid JSON","raw"=>$r];
}
function mmk($n){ return number_format((int)round((float)$n))." MMK"; }

/* ========= ID CHECK ========= */
function g2_name($r){
  return $r["name"]??$r["username"]??$r["player_name"]
    ??($r["data"]["player_name"]??($r["data"]["name"]??($r["data"]["username"]??null)));
}
function g2_check_game($game,$pid){
  $p=["game"=>(string)$game,"user_id"=>(string)$pid];

  $r=postj(G2_CHECK,$p,["Authorization: Bearer ".G2_KEY]);
  $name=g2_name($r);
  if($name) return ["ok"=>1,"name"=>$name];

  $r2=postj(G2_CHECK,$p,[]);
  $name2=g2_name($r2);
  if($name2) return ["ok"=>1,"name"=>$name2];

  return ["ok"=>0,"error"=>$r["message"]??$r2["message"]??$r["error"]??$r2["error"]??"G2_CHECK_FAIL"];
}
function ml_check($gid,$sid){
  $r=postf(ML_CHECK_API,[
    "action"=>"name-check",
    "game_id"=>(string)$gid,
    "server_id"=>(string)$sid,
    "game"=>"mlbb"
  ]);
  $name = $r["username"]??$r["name"]??$r["ign"]
       ??($r["data"]["username"]??($r["data"]["name"]??($r["data"]["ign"]??null)));
  $region = $r["region"]??($r["data"]["region"]??(string)$sid);
  return $name ? ["ok"=>1,"name"=>$name,"region"=>$region,"gameid"=>(string)$gid,"zoneid"=>(string)$sid]
               : ["ok"=>0,"error"=>$r["message"]??$r["error"]??"ML_CHECK_FAIL"];
}
function pubg_check($pid){ return g2_check_game("pubgm",$pid); }
function hok_check($pid){ return g2_check_game(HOK_GAME,$pid); }

/* ========= ORDER ========= */
function ml_order($uid,$zone,$code){
  return postf(SMILE_API,["action"=>"ml_order","user_id"=>(string)$uid,"zone_id"=>(string)$zone,"product_code"=>(string)$code]);
}
function uc_order($pid,$item,$qty=1){
  $r=postf(PUBG_API,[
    "action"=>"gameorder","type"=>"uc",
    "player_id"=>(string)$pid,
    "item_id"=>(string)$item,   // âœ… api.php uses item_id to find prices.json id
    "qty"=>(int)$qty,
    "api_key"=>(string)PUBG_KEY
  ]);
  return !empty($r["ok"]) ? ["ok"=>1,"sn"=>$r["order_no"]??"OK"] : ["ok"=>0,"error"=>$r["error"]??$r["message"]??"ORDER_FAIL","raw"=>$r];
}

/* âœ… PUBG CODE: MUST send item_id (NOT product_id) */
function code_order($itemId,$qty=1){
  $r=postf(PUBG_API,[
    "action"=>"gameorder","type"=>"code",
    "item_id"=>(string)$itemId, // âœ… IMPORTANT
    "qty"=>(int)$qty,
    "api_key"=>(string)PUBG_KEY
  ]);
  $codes=$r["codes"]??($r["data"]["codes"]??($r["code"]??($r["data"]["code"]??null)));
  return !empty($r["ok"]) ? ["ok"=>1,"sn"=>$r["order_no"]??"OK","codes"=>$codes] : ["ok"=>0,"error"=>$r["error"]??$r["message"]??"ORDER_FAIL","raw"=>$r];
}

/* ========= PRODUCTS ========= */
/* âœ… wrapper/array both supported */
function load_list($file,$mode){
  $d=jr($file);

  // wrapper object: {"pubg_code":[...]} / {"pubg_uc":[...]}
  if($mode==="CODE" && is_array($d) && isset($d["pubg_code"]) && is_array($d["pubg_code"])) $d=$d["pubg_code"];
  if($mode==="UC"   && is_array($d) && isset($d["pubg_uc"])   && is_array($d["pubg_uc"]))   $d=$d["pubg_uc"];

  // if still wrapper but file has only one key, try auto unwrap
  if($mode!=="ML" && is_array($d) && isset($d["name"])===false){
    // do nothing; we'll filter only item arrays below
  }

  $out=[];
  if(!is_array($d)) return [];
  foreach($d as $p){
    if(!is_array($p)) continue;
    $name=trim((string)($p["name"]??""));
    if($name==="") continue;
    $out[]=$p;
  }
  return $out;
}

/*
  âœ… ID PICKER (align with server api.php)
  - PUBG UC/CODE: send item_id = prices.json item's "id"
  - ML: keep existing mapping
*/
function pick_product_id($mode,$p){

  if($mode==="UC"){
    // some UC lists use products array, some use id
    if(isset($p["products"]) && is_array($p["products"]) && count($p["products"])>0){
      return array_values(array_filter(array_map("strval",$p["products"])));
    }
    $x=$p["id"]??$p["item_id"]??null;
    return $x!==null ? [(string)$x] : [];
  }

  if($mode==="CODE"){
    // âœ… MUST be id like "v60","v325" (server finds by id)
    $x=$p["id"]??null;
    return $x!==null ? [(string)$x] : [];
  }

  // ML
  $x=$p["products"]??$p["product_code"]??$p["product"]??null;
  if(is_array($x)) return array_values(array_filter(array_map("strval",$x)));
  return $x!==null ? [(string)$x] : [];
}

/* ========= UI ========= */
function home_txt($bal){
  return "ğŸŸ¡ <b>ğğ„ğ„ ğ€ğ®ğ­ğ¨ ğ“ğğ-ğ”ğ ğğğ“</b>\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n".
         "âš¡ï¸ á€„á€½á€±á€›á€¾á€­á€šá€¯á€¶á€–á€¼á€„á€·á€º 24á€”á€¬á€›á€®á€€á€¼á€­á€¯á€€á€ºá€á€²á€·á€¡á€á€»á€­á€”á€º á€á€šá€ºá€šá€°á€œá€­á€¯á€·á€›á€•á€«á€á€šá€ºá€›á€¾á€„á€·á€º\n\n".
         "ğŸ¤– ğ—•ğ—¢ğ—§ ğ—¨ğ—½ğ—±ğ—®ğ˜ğ—² ğ—–ğ—µğ—®ğ—»ğ—»ğ—²ğ—¹\n @BEE_Game_Shop\n\n".
         "ğŸ’° ğ–ğšğ¥ğ¥ğğ­ ğ€ğ¦ğ¨ğ®ğ§ğ­ğ¬ : <b>".h(mmk($bal))."</b>\n".
         "ğŸ‘¤ Admin : <b>".h(TOPUP)."</b>\n\n".
         "â¬<b>á€™á€®á€”á€°á€¸á€›á€½á€±á€¸á€•á€«á€›á€¾á€„á€·á€º</b>";
}
function kmenu(){return ["inline_keyboard"=>[
  [["text"=>"ğŸ›’ Order á€á€„á€ºá€›á€”á€º","callback_data"=>"NAV:ORDER"],["text"=>"ğŸ†” ID á€…á€…á€ºá€›á€”á€º Check","callback_data"=>"NAV:ID"]],
  [["text"=>"ğŸ“œ History á€€á€¼á€Šá€·á€ºá€›á€”á€º","callback_data"=>"SYS:HIS"],["text"=>"ğŸ’¸ Topup / á€„á€½á€±á€–á€¼á€Šá€·á€ºá€›á€”á€º","callback_data"=>"NAV:TOPUP"]],
]];}
function globalpubg(){return ["inline_keyboard"=>[
  [["text"=>"ğŸ’µ PUBG UC","callback_data"=>"ORD:UC:PAGE:0"]],
  [["text"=>"ğŸ« PUBG CODE","callback_data"=>"ORD:CODE:PAGE:0"]],
  [["text"=>"ğŸ« PUBG CODE Redeem","url"=>"https://www.midasbuy.com/midasbuy/ae/redeem/pubgm"]],
  [["text"=>"â¬…ï¸ BACK","callback_data"=>"ORD:$mode:PAGE:$page"],["text"=>"ğŸ  HOME","callback_data"=>"NAV:HOME"],],
]];}
function korder(){return ["inline_keyboard"=>[
  [["text"=>"ğŸ’ ğŒğ‹ğğ ğƒğ¢ğšğ¦ğ¨ğ§ğ ğ†ğ¥ğ¨ğ›ğšğ¥","callback_data"=>"ORD:ML:PAGE:0"]],
  [["text"=>"ğŸ’µ ğğ”ğğ† ğ”ğ‚ ğ†ğ¥ğ¨ğ›ğšğ¥","callback_data"=>"NAV:GLOBALPUBG"]],
  [["text"=>"ğŸ  HOME","callback_data"=>"NAV:HOME"]],
]];}
function kid(){return ["inline_keyboard"=>[
  [["text"=>"ğŸ’ ML  /m","callback_data"=>"HELP:ML"],["text"=>"ğŸ’µ PUBG /p","callback_data"=>"HELP:P"]],
  [["text"=>"ğŸ‘‘ HOK /h","callback_data"=>"HELP:H"],["text"=>"ğŸ  HOME","callback_data"=>"NAV:HOME"]],
]];}
function ktop(){return ["inline_keyboard"=>[
  [["text"=>"ğŸ’¬ CONTACT ADMIN","url"=>"https://t.me/".ltrim(TOPUP,"@")]],
  [["text"=>"ğŸ  HOME","callback_data"=>"NAV:HOME"]],
]];}
function kconfirm($mode,$page){return ["inline_keyboard"=>[
  [["text"=>"âœ… ğğ«ğğğ« ğ‚ğ¨ğ§ğŸğ¢ğ«ğ¦","callback_data"=>"ORD:$mode:CONFIRM"]],
  [["text"=>"â¬…ï¸ BACK","callback_data"=>"ORD:$mode:PAGE:$page"],["text"=>"ğŸ  HOME","callback_data"=>"NAV:HOME"]],
]];}
function klist($list,$mode,$page){
  $page=max(0,(int)$page);
  $max=max(0,(int)ceil(count($list)/PS)-1);
  if($page>$max) $page=$max;

  $slice=array_slice($list,$page*PS,PS,true);
  $ik=[];
  foreach($slice as $i=>$p){
    $pr=(float)($p["price"]??0);
    $ik[]=[["text"=>"â€¢ ".$p["name"]."  ".($pr>0?mmk($pr):"â€”"),"callback_data"=>"ORD:$mode:PICK:$i:$page"]];
  }
  $nav=[];
  if($page>0) $nav[]=["text"=>"â¬…ï¸ Prev","callback_data"=>"ORD:$mode:PAGE:".($page-1)];
  $nav[]=["text"=>"ğŸ  Home","callback_data"=>"NAV:HOME"];
  if($page<$max) $nav[]=["text"=>"â¡ï¸ Next","callback_data"=>"ORD:$mode:PAGE:".($page+1)];
  $ik[]=$nav;
  $ik[]=[["text"=>"â¬…ï¸ Back","callback_data"=>"NAV:ORDER"]];
  return ["inline_keyboard"=>$ik];
}

/* ========= STORE ========= */
$users=jr(UFILE);
$hist=jr(HFILE);
if(!is_array($users)) $users=[];
if(!is_array($hist)) $hist=[];

if(!isset($users[$cid])){
  $users[$cid]=["bal"=>0.0,"st"=>"","tmp"=>[]];
  jw(UFILE,$users);
}
$st=$users[$cid]["st"]??"";

/* ========= START ========= */
if($txt==="/start"){
  delm($cid,$umid);
  $users[$cid]["st"]=""; $users[$cid]["tmp"]=[];
  jw(UFILE,$users);
  send($cid,home_txt($users[$cid]["bal"]),kmenu()); exit;
}

/* ========= ID CHECK COMMANDS ========= */
if($txt){
  if(preg_match('/^\/m\s+(\d+)\s+(\d+)\s*$/i',$txt,$m)){
    $c=ml_check($m[1],$m[2]);
    send($cid, !empty($c["ok"])
      ? "âœ… <b>ğŒğ‹ ğˆğƒ ğ‚ğ¡ğğœğ¤ ğƒğ¨ğ§ğ</b>\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğğ¥ğšğ²ğğ« ğğšğ¦ğ : <b>".h($c["name"])."</b>\nğ‘ğğ ğ¢ğ¨ğ§ : <b>".h($c["region"])."</b>\nğğ¥ğšğ²ğğ« ğˆğƒ : <code>".h($c["gameid"])."</code>\nğ™ğ¨ğ§ğğˆğƒ : <code>".h($c["zoneid"])."</code>"
      : "âŒ <b>ML FAIL</b>\n<code>".h($c["error"])."</code>"
    ,kmenu()); exit;
  }
  if(preg_match('/^\/p\s+(\d{6,20})\s*$/i',$txt,$m)){
    $c=pubg_check($m[1]);
    send($cid, !empty($c["ok"])
      ? "âœ… <b>ğ™¿ğš„ğ™±ğ™¶ ğ™¸ğ™³ ğ™²ğš‘ğšğšŒğš” ğ™³ğš˜ğš—ğš</b>\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğğ¥ğšğ²ğğ« ğğšğ¦ğ : <b>".h($c["name"])."</b>\nğğ¥ğšğ²ğğ«ğˆğƒ : <code>".h($m[1])."</code>"
      : "âŒ <b>PUBG FAIL</b>\n<code>".h($c["error"])."</code>"
    ,kmenu()); exit;
  }
  if(preg_match('/^\/h\s+([0-9A-Za-z\-_]{4,25})\s*$/i',$txt,$m)){
    $c=hok_check($m[1]);
    send($cid, !empty($c["ok"])
      ? "âœ… <b>HOK ID CHECK ğ™³ğš˜ğš—ğš</b>\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğğ¥ğšğ²ğğ« ğğšğ¦ğ : <b>".h($c["name"])."</b>\nğğ¥ğšğ²ğğ«ğˆğƒ : <code>".h($m[1])."</code>"
      : "âŒ <b>HOK FAIL</b>\n<code>".h($c["error"])."</code>"
    ,kmenu()); exit;
  }
}

/* ========= CALLBACKS ========= */
if($cb){
  cbok($cbid);

  if($cb==="NAV:HOME"){ $users[$cid]["st"]=""; $users[$cid]["tmp"]=[]; jw(UFILE,$users); editm($cid,$mid,home_txt($users[$cid]["bal"]),kmenu()); exit; }
  if($cb==="NAV:GLOBALPUBG"){ editm($cid,$mid,"<b>ğğ”ğğ† ğ”ğ‚ ğ†ğ¥ğ¨ğ›ğšğ¥</b>\n<b>ğğšğœğ¤ğšğ ğ á€›á€½á€±á€¸á€á€»á€šá€ºá€•á€«á€›á€¾á€„á€·á€º â¤ï¸</b>",globalpubg()); exit; }
  if($cb==="NAV:ORDER"){ $users[$cid]["st"]=""; $users[$cid]["tmp"]=[]; jw(UFILE,$users); editm($cid,$mid,"ğŸ›’ <b>ORDER</b>\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\ná€á€šá€ºá€šá€°á€›á€”á€ºá€¡á€á€½á€€á€º Game á€›á€½á€±á€¸á€á€»á€šá€ºá€•á€«",korder()); exit; }
  if($cb==="NAV:ID"){ editm($cid,$mid,"ğŸ†” <b>ID CHECK</b>\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’ ML  : <code>/m gameid zoneid</code>\nğŸ’µ PUBG: <code>/p gameid</code>\nğŸ‘‘ HOK : <code>/h gameid</code>",kid()); exit; }
  if($cb==="NAV:TOPUP"){ editm($cid,$mid,"ğŸ’¸ <b>Topup / á€„á€½á€±á€–á€¼á€Šá€·á€ºá€›á€”á€º</b>\n\nUID á€¡á€¬á€¸ Admin á€¡á€¬á€¸á€•á€­á€¯á€•á€«á€›á€¾á€„á€·á€ºâœ…\nUID : <code>$cid</code>\nAdmin : <b>".h(TOPUP)."</b>",ktop()); exit; }

  if($cb==="SYS:HIS"){
    $hist=jr(HFILE); $list=$hist[$cid]??[];
    if(!$list){ editm($cid,$mid,"ğŸ“œ <b>HISTORY</b>\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâ€” No history â€”",["inline_keyboard"=>[[["text"=>"ğŸ  HOME","callback_data"=>"NAV:HOME"]]]]); exit; }
    $x=end($list);
    editm($cid,$mid,"ğŸ“œ <b>HISTORY</b>\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nTime: ".h($x["time"]??"-")."\nGame: ".h($x["game"]??"-")."\nItem: ".h($x["order"]??"-")."\nSN: <code>".h($x["sn"]??"-")."</code>",["inline_keyboard"=>[[["text"=>"ğŸ  HOME","callback_data"=>"NAV:HOME"]]]]); exit;
  }

  if(preg_match('/^ORD:(ML|UC|CODE):PAGE:(\d+)$/',$cb,$m)){
    $mode=$m[1]; $page=(int)$m[2];
    $file=($mode==="ML")?ML_FILE:(($mode==="UC")?UC_FILE:CODE_FILE);
    $list=load_list($file,$mode);

    $users[$cid]["tmp"]=["mode"=>$mode,"page"=>$page,"list"=>$list]; $users[$cid]["st"]=""; jw(UFILE,$users);

    $title=($mode==="ML")?"ğŸ’ <b>ğŒğ‹ğğ ğƒğ¢ğšğ¦ğ¨ğ§ğ</b>":(($mode==="UC")?"ğŸ’µ <b>ğğ”ğğ† ğ”ğ‚</b>":"ğŸ« <b>ğğ”ğğ† ğ”ğ‚ ğ‚ğ¨ğğ</b>");
    editm($cid,$mid,$title."  ğğ«ğ¢ğœğğ¬ ğ‹ğ¢ğ¬ğ­\nğ–ğšğ¢ğ­ğ¢ğ§ğ  ğ­ğ¢ğ¦ğ ğŸğ’ğğœ / á€™á€…á€±á€¬á€„á€ºá€·á€›á€•á€«á€›á€¾á€„á€·á€º â¤ï¸",klist($list,$mode,$page)); exit;
  }

  if(preg_match('/^ORD:(ML|UC|CODE):PICK:(\d+):(\d+)$/',$cb,$m)){
    $mode=$m[1]; $idx=(int)$m[2]; $page=(int)$m[3];
    $list=$users[$cid]["tmp"]["list"]??[];
    if(!isset($list[$idx])){ editm($cid,$mid,"âŒ Item not found",korder()); exit; }

    $pick=$list[$idx];
    $codes=pick_product_id($mode,$pick);
    if(!$codes){ editm($cid,$mid,"âŒ Product ID missing\n(á€–á€­á€¯á€„á€ºá€‘á€² id/products á€…á€…á€ºá€•á€«)",korder()); exit; }

    $users[$cid]["tmp"]=["mode"=>$mode,"page"=>$page,"pick"=>$pick,"codes"=>$codes];
    $users[$cid]["st"]=($mode==="ML")?"WAIT_ML":(($mode==="UC")?"WAIT_PUBG":"WAIT_QTY");
    jw(UFILE,$users);

    $need=($mode==="ML")?"ğŸ’ ML ID á€‘á€Šá€·á€ºá€•á€«\n<code>gameid zoneid</code>"
        :(($mode==="UC")?"ğŸ’µ PUBG ID á€‘á€Šá€·á€ºá€•á€«\n<code>gameid</code>"
        :"ğŸ« Qty á€‘á€Šá€·á€ºá€•á€«\n<code>1-50</code>");

    $pr=(float)($pick["price"]??0);
    editm($cid,$mid,"âœ… <b>Selected</b>\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n".
      "Item: <b>".h($pick["name"])."</b>\n".
      "Price: <b>".h($pr>0?mmk($pr):"â€”")."</b>\n\n".$need,
      ["inline_keyboard"=>[
     [["text"=>"â¬…ï¸ Back","callback_data"=>"ORD:$mode:PAGE:$page"],["text"=>"ğŸ  HOME","callback_data"=>"NAV:HOME"]],
      ]]
    ); exit;
  }

  if(preg_match('/^ORD:(ML|UC|CODE):CONFIRM$/',$cb,$m)){
    $mode=$m[1];
    if(($users[$cid]["st"]??"")!==("READY_$mode")){ editm($cid,$mid,"â³ Session Lost\n/start",kmenu()); exit; }

    $t=$users[$cid]["tmp"]; $pick=$t["pick"]??null; $codes=$t["codes"]??[];
    if(!$pick || !$codes){ editm($cid,$mid,"â³ Session Lost\n/start",kmenu()); exit; }

    $unit=(float)($pick["price"]??0);
    $qty = ($mode==="CODE") ? max(1,min(50,(int)($t["qty"]??1))) : 1;
    $price= ($mode==="CODE") ? ($unit*$qty) : $unit;

    if((float)$users[$cid]["bal"] < $price){ editm($cid,$mid,"ğŸ’” á€œá€€á€ºá€€á€»á€”á€ºá€„á€½á€±á€™á€œá€±á€¬á€€á€ºá€•á€«á€›á€¾á€„á€·á€º\n\nAdmin - ".h(TOPUP)."\nUID : <code>$cid</code>",kmenu()); exit; }

    editm($cid,$mid,"â³ Processing...\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");

    $sn=""; $err=""; $got=null;

    foreach($codes as $code){
      if($mode==="ML"){
        $r=ml_order($t["uid"],$t["zone"],$code);
        if(empty($r["ok"])){$err=$r["error"]??$r["message"]??"ML_ORDER_FAIL"; break;}
        $sn=$sn?:($r["order_id"]??"OK");
      }elseif($mode==="UC"){
        $r=uc_order($t["pid"],$code,1);
        if(empty($r["ok"])){$err=$r["error"]??"UC_ORDER_FAIL"; break;}
        $sn=$sn?:($r["sn"]??"OK");
      }else{
        $r=code_order($code,$qty); // âœ… CODE uses item_id now
        if(empty($r["ok"])){$err=$r["error"]??"CODE_ORDER_FAIL"; break;}
        $sn=$sn?:($r["sn"]??"OK");
        $got=$r["codes"]??null;
      }
    }

    if($err){ editm($cid,$mid,"âŒ <b>ORDER FAIL</b>\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n<code>".h($err)."</code>",kmenu()); exit; }

    $users[$cid]["bal"]=(float)$users[$cid]["bal"]-$price;

    $hist=jr(HFILE); if(!is_array($hist)) $hist=[];
    if(!isset($hist[$cid])||!is_array($hist[$cid])) $hist[$cid]=[];
    $hist[$cid][]=["time"=>date("H:i d.m.Y"),"game"=>$mode,"order"=>$pick["name"],"sn"=>$sn,"amount"=>$price];
    jw(HFILE,$hist);

    $users[$cid]["st"]=""; $users[$cid]["tmp"]=[]; jw(UFILE,$users);

    $extra="";
    if($mode==="CODE" && $got){
      $extra.="\n\nğŸ« <b>ğ˜ğ¨ğ®ğ« ğğ”ğğ† ğ‚ğ¨ğğ</b>\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";
      if(is_array($got)){ $i=0; foreach($got as $c){ if(++$i>20) break; $extra.="â€¢ <code>".h($c)."</code>\n"; } }
      else $extra.="â˜© <code>".h($got)."</code>\n\n<b>Copy á€šá€°á€•á€¼á€®á€¸á€á€­á€™á€ºá€¸á€‘á€¬á€¸á€•á€«á€›á€¾á€„á€·á€º âœ…</b>";
    }

    editm($cid,$mid,"âœ… <b>ğ’ğ”ğ‚ğ‚ğ„ğ’ğ’</b>\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n".
      "Item: <b>".h($pick["name"])."</b>\n".
      (($mode==="CODE")?("Qty : <b>$qty</b>\n"):"").
      "SN  : <code>".h($sn)."</code>\n".
      "Paid : <b>".h(mmk($price))."</b>\n".
      "Now : <b>".h(mmk($users[$cid]["bal"]))."</b>".$extra,
      kmenu()
    ); exit;
  }

  editm($cid,$mid,home_txt($users[$cid]["bal"]),kmenu()); exit;
}

/* ========= STATES ========= */
if($st==="WAIT_ML" && $txt){
  if(!preg_match('/^(\d+)\s+(\d+)$/',$txt,$m)){ send($cid,"âŒ Format: <code>gameid zoneid</code>",kmenu()); exit; }
  $c=ml_check($m[1],$m[2]); if(empty($c["ok"])){ $users[$cid]["st"]=""; $users[$cid]["tmp"]=[]; jw(UFILE,$users); send($cid,"âŒ ML FAIL\n<code>".h($c["error"])."</code>",kmenu()); exit; }
  $users[$cid]["st"]="READY_ML"; $users[$cid]["tmp"]["uid"]=$c["gameid"]; $users[$cid]["tmp"]["zone"]=$c["zoneid"]; jw(UFILE,$users);
  $page=(int)($users[$cid]["tmp"]["page"]??0);
  send($cid,"âœ… <b>ğ— ğ—Ÿğ—•ğ—• ğ—¢ğ—¿ğ—±ğ—²ğ—¿ ğ—–ğ—¼ğ—»ğ—³ğ—¶ğ—¿ğ—º</b>\nName: <b>".h($c["name"])."</b>\nGameID: <code>".h($c["gameid"])."</code> Zone: <code>".h($c["zoneid"])."</code>",kconfirm("ML",$page)); exit;
}
if($st==="WAIT_PUBG" && $txt){
  if(!preg_match('/^\d{6,20}$/',$txt)){ send($cid,"âŒ Format: <code>gameid</code>",kmenu()); exit; }
  $c=pubg_check($txt); if(empty($c["ok"])){ $users[$cid]["st"]=""; $users[$cid]["tmp"]=[]; jw(UFILE,$users); send($cid,"âŒ PUBG FAIL\n<code>".h($c["error"])."</code>",kmenu()); exit; }
  $users[$cid]["st"]="READY_UC"; $users[$cid]["tmp"]["pid"]=$txt; jw(UFILE,$users);
  $page=(int)($users[$cid]["tmp"]["page"]??0);
  send($cid,"âœ… <b>ğğ”ğğ† ğ”ğ‚ ğğ«ğğğ« ğ‚ğ¨ğ§ğŸğ¢ğ«ğ¦</b>\nName: <b>".h($c["name"])."</b>\nGameID: <code>".h($txt)."</code>",kconfirm("UC",$page)); exit;
}
if($st==="WAIT_QTY" && $txt){
  if(!preg_match('/^\d{1,2}$/',$txt)){ send($cid,"âŒ Qty: <code>1-50</code>",kmenu()); exit; }
  $qty=max(1,min(50,(int)$txt));
  $users[$cid]["st"]="READY_CODE"; $users[$cid]["tmp"]["qty"]=$qty; jw(UFILE,$users);
  $page=(int)($users[$cid]["tmp"]["page"]??0);
  send($cid,"âœ… <b>ğğ”ğğ† ğ‚ğğƒğ„ ğğ«ğğğ« ğ‚ğ¨ğ§ğŸğ¢ğ«ğ¦</b>\nQty : <b>$qty</b>",kconfirm("CODE",$page)); exit;
}

/* ========= FALLBACK ========= */
if($txt) send($cid,home_txt($users[$cid]["bal"]),kmenu());